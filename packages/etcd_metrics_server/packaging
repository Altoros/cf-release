set -e

REPO_NAME=github.com/cloudfoundry-incubator/etcd-metrics-server

REPO_DIR=${BOSH_INSTALL_TARGET}/src/${REPO_NAME}

mkdir -p $(dirname $REPO_DIR)

cp -a $(basename $REPO_NAME)/ $REPO_DIR

if [ "`uname -m`" == "ppc64le" ]; then
  export GOROOT=$(readlink -nf /var/vcap/packages/gccgo/gccgo)
  export LD_LIBRARY_PATH=$GOROOT/lib64
  export BUILD_OPTIONS="-compiler gccgo -gccgoflags '-static-libgo'"
  # we need following steps to make gccgo work
  ln -s $GOROOT /usr/local/gccgo
  cp -f $GOROOT/lib64/libgo.so.7 /lib/powerpc64le-linux-gnu
else
  export GOROOT=$(readlink -nf /var/vcap/packages/golang1.3)
fi

export GOPATH=$BOSH_INSTALL_TARGET:${REPO_DIR}/Godeps/_workspace
export PATH=$GOROOT/bin:$PATH

go install $BUILD_OPTIONS ${REPO_NAME}
