set -e -x

cd ${BUILD_DIR}

# move the warden server bits into the root of the package
#
# this turns warden/warden/* into warden/*
mv warden tmp_warden
mv tmp_warden/warden .
mv tmp_warden/warden-client .
mv tmp_warden/warden-protocol .
rmdir tmp_warden

cd warden

if [[ "`bundle --version`" != *"1.7.2"* ]]; then
  echo "You should use bundler with version 1.7.2"
  exit 2
fi

# ?: why doesn't it work?
# ?: why dea_next_gems/dea_next_gems_vendor_cache.tar.gz does not exist
# if [ "`uname -m`" == "ppc64le" ]; then
#   tar -xvfz dea_next_gems/dea_next_gems_vendor_cache.tar.gz
#   gem install --local nokogiry -v 1.6.2.1 --no-ri --no-rdoc
#   rm -rf vendor
# fi

rvm all do gem install rake -v 0.9.2.2
BUNDLE_WITHOUT=development:test bundle package --all
