set -e -x

cd ${BUILD_DIR}

# move the warden server bits into the root of the package
#
# this turns warden/warden/* into warden/*
mv warden tmp_warden
mv tmp_warden/warden .
mv tmp_warden/warden-client .
mv tmp_warden/warden-protocol .
rmdir tmp_warden

cd warden

if [[ "`bundle --version`" != *"1.3.5"* ]]; then
  echo "You should use bundler with version 1.3.5"
  exit 2
fi

rvm all do gem install rake -v 0.9.2.2

if [ "`uname -m`" == "ppc64le" ]; then
  tar -xvfz dea_next_gems/dea_next_gems_vendor_cache.tar.gz
  gem install --local nokogiry
  rm -rf vendor
fi

BUNDLE_WITHOUT=development:test bundle package --all
