set -e -x

cd ${BOSH_INSTALL_TARGET}
if [ `uname -m` = "ppc64le" ]; then
  JDK_ARCHIVE_PATH=${BOSH_COMPILE_TARGET}/openjdk/java-7-openjdk-ppc64el.tgz
else
  JDK_ARCHIVE_PATH=${BOSH_COMPILE_TARGET}/uaa/openjdk-1.7.0_51.tar.gz
fi

mkdir jdk && tar zxvf $JDK_ARCHIVE_PATH -C jdk

if [[ $? != 0 ]] ; then
  echo "Cannot unpack JDK"
  exit 1
fi

cd ${BOSH_INSTALL_TARGET}

tar zxvf ${BOSH_COMPILE_TARGET}/uaa/apache-tomcat-7.0.55.tar.gz
if [[ $? != 0 ]] ; then
  echo "Cannot unpack Tomcat"
  exit 1
fi

mv apache-tomcat-7.0.55 tomcat

cd tomcat
rm -rf webapps/*
cp -a ${BOSH_COMPILE_TARGET}/login/cloudfoundry-login-server.war webapps/ROOT.war
cp -a ${BOSH_COMPILE_TARGET}/uaa/cloudfoundry-identity-varz-1.0.2.war webapps/varz.war

cd ${BOSH_INSTALL_TARGET}
cp -a ${BOSH_COMPILE_TARGET}/cf-registrar-bundle-for-identity vcap-common
cd vcap-common
/var/vcap/packages/ruby-2.1.4/bin/bundle install --binstubs --deployment --local --without=development test

