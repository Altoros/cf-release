set -e -x

if [ "`uname -m`" == "ppc64le" ]; then
  export GOROOT=$(readlink -nf /var/vcap/packages/gccgo/gccgo)
  export LD_LIBRARY_PATH=$GOROOT/lib64
  ln -s $GOROOT /usr/local/gccgo
  BUILD_OPTIONS="-compiler gccgo -gccgoflags '-static-libgo'"
else
  export GOROOT=$(readlink -nf /var/vcap/packages/golang1.4)
fi

export PATH=$GOROOT/bin:$PATH
export GOPATH=$PWD/loggregator

go install $BUILD_OPTIONS metron
cp -a $PWD/loggregator/bin/metron ${BOSH_INSTALL_TARGET}

mkdir -p ${BOSH_INSTALL_TARGET}/syslog_daemon_config
cp -a $PWD/loggregator/src/metron/syslog_daemon_config/* ${BOSH_INSTALL_TARGET}/syslog_daemon_config
